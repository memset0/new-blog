var Home=location.href,Pages=4,xhr,xhrUrl="",Diaspora={L:function(url,f,err){if(url==xhrUrl)return!1;xhrUrl=url,xhr&&xhr.abort(),xhr=$.ajax({type:"GET",url:url,timeout:1e4,success:function(data){f(data),xhrUrl="",ajaxLoadList.forEach(loader=>{loader()})},error:function(a,b,c){"abort"==b?err&&err():window.location.href=url,xhrUrl=""}})},P:function(){return!!("ontouchstart"in window)},PS:function(){window.history&&history.pushState&&(history.replaceState({u:Home,t:document.title},document.title,Home),window.addEventListener("popstate",(function(e){var state=e.state;state&&(document.title=state.t,state.u==Home?($("#preview").css("position","fixed"),setTimeout((function(){$("#preview").removeClass("show"),$("#container").show(),window.scrollTo(0,parseInt($("#container").data("scroll"))),setTimeout((function(){$("#preview").html(""),$(window).trigger("resize")}),300)}),0)):(Diaspora.loading(),Diaspora.L(state.u,(function(data){document.title=state.t,$("#preview").html($(data).filter("#single")),Diaspora.preview(),setTimeout((function(){Diaspora.player()}),0)}))))})))},HS:function(tag,flag){var id=tag.data("id")||0,url=tag.attr("href"),title=tag.attr("title")+" - "+$("#config-title").text();$("#preview").length&&window.history&&history.pushState||(location.href=url),Diaspora.loading();var state={d:id,t:title,u:url};Diaspora.L(url,(function(data){if($(data).filter("#single").length){switch(flag){case"push":history.pushState(state,title,url);break;case"replace":history.replaceState(state,title,url)}switch(document.title=title,$("#preview").html($(data).filter("#single")),flag){case"push":Diaspora.preview();break;case"replace":window.scrollTo(0,0),Diaspora.loaded()}setTimeout((function(){Diaspora.player(),$("#top").show(),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click()}),0)}else location.href=url}))},preview:function(){$("#preview").one("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",(function(){var previewVisible;$("#preview").hasClass("show")?$("#container").hide():$("#container").show(),Diaspora.loaded()})),setTimeout((function(){$("#preview").addClass("show"),$("#container").data("scroll",window.scrollY),setTimeout((function(){$("#preview").css({position:"static","overflow-y":"auto"})}),500)}),0)},player:function(){function saveCurrentTime(src,time){localStorage.setItem("audio-"+$.md5(src),String(time))}function loadCurrentTime(src){var data=localStorage.getItem("audio-"+$.md5(src));return console.log(src,data,isNaN(data)?0:parseInt(data)),isNaN(parseInt(data))?0:parseInt(data)}var p=$("#audio"),sourceSrc;p.length?(""==$("#audio source").eq(0).attr("src")&&""==p[0].src&&(audiolist=$("#audio-list li"),mp3=audiolist.eq([Math.floor(Math.random()*audiolist.size())]),p[0].src=mp3.data("url"),p[0].load()),1==p.eq(0).data("autoplay")&&p[0].play(),console.log(p[0]),p.on({loadedmetadata:function(){},timeupdate:function(){p[0].currentTime>0&&saveCurrentTime(p[0].src,p[0].currentTime);var progress=p[0].currentTime/p[0].duration*100;$(".bar").css("width",progress+"%"),p[0].volume=progress/5<=1?progress/5:1},ended:function(){$(".icon-pause").removeClass("icon-pause").addClass("icon-play")},playing:function(){$(".icon-play").removeClass("icon-play").addClass("icon-pause")}})):$(".icon-play").css({color:"#dedede",cursor:"not-allowed"})},loading:function(){var w=window.innerWidth,css='<style class="loaderstyle" id="loaderstyle'+w+'">@-moz-keyframes loader'+w+"{100%{background-position:"+w+"px 0}}@-webkit-keyframes loader"+w+"{100%{background-position:"+w+"px 0}}.loader"+w+"{-webkit-animation:loader"+w+" 3s linear infinite;-moz-animation:loader"+w+" 3s linear infinite;}</style>";$(".loaderstyle").remove(),$("head").append(css),$("#loader").removeClass().addClass("loader"+w).show()},loaded:function(){$("#loader").removeClass().hide()},F:function(id,w,h){var _height=$(id).parent().height(),_width=$(id).parent().width(),ratio=h/w;_height/_width>ratio?(id.style.height=_height+"px",id.style.width=_height/ratio+"px"):(id.style.width=_width+"px",id.style.height=_width*ratio+"px"),id.style.left=(_width-parseInt(id.style.width))/2+"px",id.style.top=(_height-parseInt(id.style.height))/2+"px"}};$((function(){if(Diaspora.P()&&$("body").addClass("touch"),$("#preview").length){var cover={},T;cover.t=$("#cover"),cover.w=cover.t.attr("width"),cover.h=cover.t.attr("height"),(cover.o=function(){$("#mark").height(window.innerHeight)})(),cover.t.prop("complete")&&setTimeout((function(){cover.t.load()}),0),cover.t.on("load",(function(){(cover.f=function(){var _w=$("#mark").width(),_h=$("#mark").height(),x,y,i,e;e=_w>=1e3||_h>=1e3?1e3:500,_w>=_h?(y=i=_w/e*50,x=i*_w/_h):(x=i=_h/e*50,y=i*_h/_w),$(".layer").css({width:_w+x,height:_h+y,marginLeft:-.5*x,marginTop:-.5*y}),cover.w||(cover.w=cover.t.width(),cover.h=cover.t.height()),Diaspora.F($("#cover")[0],cover.w,cover.h)})(),setTimeout((function(){$("html, body").removeClass("loading")}),1e3),$("#mark").parallax();var vibrant,swatches=new Vibrant(cover.t[0]).swatches();swatches.DarkVibrant&&($("#vibrant polygon").css("fill",swatches.DarkVibrant.getHex()),$("#vibrant div").css("background-color",swatches.DarkVibrant.getHex())),swatches.Vibrant&&($(".icon-menu").css("color",swatches.Vibrant.getHex()),$(".icon-search").css("color",swatches.Vibrant.getHex()))})),cover.t.attr("src")||alert("Please set the post thumbnail"),$("#preview").css("min-height",window.innerHeight),Diaspora.PS(),$(".pview a").addClass("pviewa"),$(window).on("resize",(function(){clearTimeout(T),T=setTimeout((function(){Diaspora.P()||location.href!=Home||(cover.o(),cover.f()),$("#loader").attr("class")&&Diaspora.loading()}),500)}))}else $("#single").css("min-height",window.innerHeight),setTimeout((function(){$("html, body").removeClass("loading")}),1e3),window.addEventListener("popstate",(function(e){e.state&&(location.href=e.state.u)})),Diaspora.player(),$(".icon-icon, .image-icon").attr("href","/"),$("#top").show();$(window).on("scroll",(function(){if($(".scrollbar").length&&!Diaspora.P()&&!$(".icon-images").hasClass("active")){var wt=$(window).scrollTop(),tw,dh,wh,width=$("#top").width()/(document.body.scrollHeight-$(window).height())*wt;$(".scrollbar").width(width),wt>80&&window.innerWidth>800?($(".subtitle").fadeIn(),$("#top").addClass("shadowed")):($(".subtitle").fadeOut(),$("#top").removeClass("shadowed"))}})),$(window).on("touchmove",(function(e){$("body").hasClass("mu")&&e.preventDefault()}));var searchFunc=function(path,search_id,content_id){"use strict";$.ajax({url:path,dataType:"xml",success:function(xmlResponse){var datas=$("entry",xmlResponse).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get(),$input=document.getElementById(search_id),$resultContent=document.getElementById(content_id);$input.addEventListener("input",(function(){var str='<ul class="search-result-list">',keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="",this.value.trim().length<=0||(datas.forEach((function(data){var isMatch=!0,content_index=[],data_title=data.title.trim().toLowerCase(),data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),data_url=data.url,index_title=-1,index_content=-1,first_occur=-1;if(""!=data_title&&""!=data_content&&keywords.forEach((function(keyword,i){index_title=data_title.indexOf(keyword),index_content=data_content.indexOf(keyword),index_title<0&&index_content<0?isMatch=!1:(index_content<0&&(index_content=0),0==i&&(first_occur=index_content))})),isMatch){str+="<li><a href='/"+data_url+"' class='search-result-title' target='_blank'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-6,end=first_occur+6;start<0&&(start=0),0==start&&(end=10),end>content.length&&(end=content.length);var match_content=content.substr(start,end);keywords.forEach((function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,'<em class="search-keyword">'+keyword+"</em>")})),str+='<p class="search-result">'+match_content+"...</p>"}}})),$resultContent.innerHTML=str)}))}})},path="/search.xml";null!==document.getElementById("local-search-input")&&searchFunc(path,"local-search-input","local-search-result");var typed=null;$("body").on("click",(function(e){var tag=$(e.target).attr("class")||"",rel=$(e.target).attr("rel")||"";if("IMG"==e.target.nodeName&&$(e.target).parents("div.content").length>0&&(tag="pimg"),tag||rel)switch(!0){case-1!=tag.indexOf("switchmenu"):return window.scrollTo(0,0),$("html, body").toggleClass("mu"),null!==typed?(typed.destroy(),typed=null):1==$("#hitokoto").data("st")&&$.get("https://v1.hitokoto.cn/",(function(data){var data,str,options={strings:[(data=data).hitokoto+" ——  By "+data.from],typeSpeed:90,startDelay:500};typed=new Typed(".hitokoto .typed",options)})),!1;case-1!=tag.indexOf("switchsearch"):return $("body").removeClass("mu"),null!==typed&&(typed.destroy(),typed=null),setTimeout((function(){Diaspora.HS($(e.target),"push"),$(".toc").fadeIn(1e3),searchFunc(path,"local-search-input","local-search-result")}),300),!1;case-1!=tag.indexOf("more"):if("loading"==(tag=$(".more")).data("status"))return!1;var num=parseInt(tag.data("page"))||1;if(1==num&&tag.data("page",1),num>=Pages)return;return tag.html("加载中...").data("status","loading"),Diaspora.loading(),Diaspora.L(tag.attr("href"),(function(res){var data=$(res),link=data.find(".more").attr("href");null!=link?(tag.attr("href",link).html("加载更多").data("status","loaded"),tag.data("page",parseInt(tag.data("page"))+1)):$("#pager").remove(),data.find(".post img.cover").hide();var tempScrollTop=$(window).scrollTop();$("#primary").append(data.find(".post")),$("#primary .post img.cover").each((function(){this.onload=function(){$(this).fadeIn(),console.info("image load",$(this).attr("src"))}})),$(window).scrollTop(tempScrollTop+100),Diaspora.loaded(),$("html,body").animate({scrollTop:tempScrollTop+400},500)}),(function(){tag.html("加载更多").data("status","loaded")})),!1;case-1!=tag.indexOf("icon-home"):return $(".toc").fadeOut(100),$("#preview").hasClass("show")?history.back():location.pathname=$(".icon-home").data("url"),!1;case-1!=tag.indexOf("icon-scan"):return $(".icon-scan").hasClass("tg")||($(".icon-scan").addClass("tg"),$("#qr").qrcode({width:128,height:128,text:location.href})),$("#qr").fadeToggle(),!1;case-1!=tag.indexOf("icon-play"):return $("#audio")[0].play(),$(".icon-play").removeClass("icon-play").addClass("icon-pause"),!1;case-1!=tag.indexOf("icon-pause"):return $("#audio")[0].pause(),$(".icon-pause").removeClass("icon-pause").addClass("icon-play"),!1;case-1!=tag.indexOf("cover"):return Diaspora.HS($(e.target).parent(),"push"),!1;case-1!=tag.indexOf("posttitle"):return Diaspora.HS($(e.target),"push"),!1;case"prev"==rel||"next"==rel:if("prev"==rel)var t=$("#prev_next a")[0].text;else var t=$("#prev_next a")[1].text;return $(e.target).attr("title",t),Diaspora.HS($(e.target),"replace"),!1;case-1!=tag.indexOf("toc-text")||-1!=tag.indexOf("toc-link")||-1!=tag.indexOf("toc-number"):return hash="","SPAN"==e.target.nodeName?hash=$(e.target).parent().attr("href"):hash=$(e.target).attr("href"),to=$("a.headerlink[href='"+hash+"']"),$("html,body").animate({scrollTop:to.offset().top-50},300),!1;case-1!=tag.indexOf("pviewa"):return $("body").removeClass("mu"),null!==typed&&(typed.destroy(),typed=null),setTimeout((function(){Diaspora.HS($(e.target),"push"),$(".toc").fadeIn(1e3)}),300),!1;case-1!=tag.indexOf("pimg"):var pswpElement=$(".pswp").get(0);if(pswpElement){var items=[],index=0,imgs=[],options,lightBox;$(".content img").each((function(i,v){e.target.src==v.src&&(index=i);var item={src:v.src,w:v.naturalWidth,h:v.naturalHeight};imgs.push(v),items.push(item)})),new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,{index:index,shareEl:!1,zoomEl:!1,allowRotationOnUserZoom:!0,history:!1,getThumbBoundsFn:function(index){var thumbnail=imgs[index],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width}}}).init()}return!1;case-1!=tag.indexOf("comment"):return 1==$("#gitalk-container").data("enable")?(Diaspora.loading(),comment=$("#gitalk-container"),gitalk=new Gitalk({clientID:comment.data("ci"),clientSecret:comment.data("cs"),repo:comment.data("r"),owner:comment.data("o"),admin:comment.data("a"),id:decodeURI(window.location.pathname),distractionFreeMode:comment.data("d")}),$(".comment").removeClass("link"),gitalk.render("gitalk-container"),Diaspora.loaded()):$("#gitalk-container").html("评论已关闭"),!1;default:return!0}})),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click(),console.log("%c Github %c","background:#24272A; color:#ffffff","","https://github.com/Fechin/hexo-theme-diaspora")}));